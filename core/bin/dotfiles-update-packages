#!/bin/bash
# Update all installed packages

source "${DOTFILES_PACKAGE_SCRIPTS}/update-package.bash" || exit 1

function update-packages() {
    PACKAGE_CONF_ROOT="${1}"

    exec 3< <(ls -1 "${PACKAGE_CONF_ROOT}")
    while read -r -u 3 line; do
        if ! update-package "${line}"; then
            rmdir "${DOTFILES_PACKAGE_MUTEX}"
            return 1
        fi
    done
}

function cleanup() {
    rmdir "${DOTFILES_PACKAGE_MUTEX}"
}

function fail() {
    echo-red 'Updating packages failed.'
    cleanup
    exit 1
}

if mkdir "${DOTFILES_PACKAGE_MUTEX}" &>/dev/null; then
    trap fail SIGINT SIGTERM

    if [ -e "${DOTFILES_PACKAGE_INSTALL_DIR}" ]; then
        if [ -d "${DOTFILES_PRIVATE_DIR}" ]; then
            if dotfiles-repo-is-clean "${DOTFILES_PRIVATE_DIR}"; then
                # shellcheck disable=SC2015
                cd "{DOTFILES_PRIVATE_DIR}" &&
                git pull || fail
            else
                echo-yellow 'Private repo has uncommitted changes; not updating it.'
            fi
        fi

        update-packages "${DOTFILES_PACKAGE_CONF_DIR}" || fail
        if [ -d "${DOTFILES_PRIVATE_PACKAGE_CONF_DIR}" ]; then
            update-packages "${DOTFILES_PRIVATE_PACKAGE_CONF_DIR}" || fail
        fi

        date '+%s' > "${UPDATE_FILE}"

        if [ -e "${DOTFILES_NEEDS_LOGOUT}" ]; then
            echo-yellow 'Log out and log in again to set everything up correctly.'
        fi
    fi
    cleanup
else
    echo-yellow 'Another shell is installing or updating packages; cannot update here.'
fi
